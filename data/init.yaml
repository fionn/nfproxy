#cloud-config

packages:
  - nftables
  - nc

runcmd:
  - [ mv, /etc/sysconfig/nftables.conf, /etc/sysconfig/nftables.conf.backup ]

write_files:
  - path: /etc/sysctl.d/95-ip-forwarding.conf
    content: net.ipv4.ip_forward=1
    permissions: "0644"
  - path: /etc/sysconfig/nftables.conf
    content: |
      #!/usr/sbin/nft -f

      flush ruleset

      table ip nat {
        chain prerouting {
          type nat hook prerouting priority dstnat; policy accept;
          tcp dport ${proxy_source_port} dnat to ${proxy_destination_address}:${proxy_destination_port}
        }

        chain postrouting {
          type nat hook postrouting priority srcnat; policy accept;
          masquerade
        }
      }
    permissions: "0600"

runcmd:
  - [ sysctl, -p, /etc/sysctl.d/95-ip-forwarding.conf ]
  - [ systemctl, reload-or-restart, nftables.service ]
  - [ systemctl, enable, nftables.service ]
  - nc -vz $(curl -fs http://169.254.169.254/latest/meta-data/public-ipv4) ${proxy_source_port}

#package_update: true
#package_upgrade: true
#package_reboot_if_required: true
